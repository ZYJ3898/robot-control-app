name: Build Android APK

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        path: 'robot-app'
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          ccache \
          autoconf \
          automake \
          libtool \
          libffi-dev \
          libssl-dev \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libsqlite3-dev \
          libreadline-dev \
          libbz2-dev \
          libgdbm-dev \
          liblzma-dev \
          tk-dev \
          libxml2-dev \
          libxslt-dev \
          libgtk2.0-0 \
          libsdl2-2.0-0 \
          libsdl2-image-2.0-0 \
          libsdl2-mixer-2.0-0 \
          libsdl2-ttf-2.0-0 \
          libportmidi0 \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev
        sudo apt-get clean
    
    - name: å®‰è£…Buildozer
      run: |
        python -m pip install --upgrade pip
        pip install buildozer==1.4.0 cython==0.29.33 virtualenv
        pip install kivy==2.1.0  # é¢„è£…kivyï¼ŒåŠ é€Ÿæ„å»º
    
    - name: é…ç½®Buildozer
      run: |
        cd robot-app
        # å¦‚æœå·²æœ‰buildozer.specåˆ™è·³è¿‡åˆå§‹åŒ–
        if [ ! -f "buildozer.spec" ]; then
          buildozer init
        fi
        
        # å¤‡ä»½åŸå§‹specæ–‡ä»¶
        cp buildozer.spec buildozer.spec.backup
        
        # ä½¿ç”¨sedä¿®æ”¹é…ç½®
        sed -i "s|^title = My Application|title = æœºå™¨äººæ§åˆ¶|g" buildozer.spec
        sed -i "s|^package.name = myapp|package.name = robotcontrol|g" buildozer.spec
        sed -i "s|^package.domain = org.test|package.domain = org.robot|g" buildozer.spec
        sed -i "s|^source.dir = .|source.dir = .|g" buildozer.spec
        sed -i "s|^source.include_exts = py,png,jpg,kv,atlas|source.include_exts = py,png,jpg,kv,atlas,ttf|g" buildozer.spec
        sed -i "s|^version = 0.1|version = 1.0|g" buildozer.spec
        sed -i "s|^requirements = python3,kivy|requirements = python3,kivy==2.1.0|g" buildozer.spec
        sed -i "s|^android.api = 27|android.api = 33|g" buildozer.spec
        sed -i "s|^android.minapi = 21|android.minapi = 21|g" buildozer.spec
        sed -i "s|^android.sdk = 20|android.sdk = 33|g" buildozer.spec
        sed -i "s|^android.ndk = 19b|android.ndk = 25b|g" buildozer.spec
        sed -i "s|^android.ndk_api = 21|android.ndk_api = 21|g" buildozer.spec
        sed -i "s|^android.permissions = .*|android.permissions = INTERNET|g" buildozer.spec
        sed -i "s|^android.wakelock = False|android.wakelock = True|g" buildozer.spec
        sed -i "s|^orientation = portrait|orientation = portrait|g" buildozer.spec
        sed -i "s|^fullscreen = 0|fullscreen = 0|g" buildozer.spec
        
        # æ·»åŠ ä¸­æ–‡æ”¯æŒ
        echo "" >> buildozer.spec
        echo "# ä¸­æ–‡æ”¯æŒ" >> buildozer.spec
        echo "android.accept_sdk_license = True" >> buildozer.spec
        echo "android.gradle_dependencies = \\" >> buildozer.spec
        echo "    'com.android.support:multidex:1.0.3'" >> buildozer.spec
        
        # è®¾ç½®ä¸»æ–‡ä»¶
        sed -i "s|^main = main.py|main = main.py|g" buildozer.spec
        
        # æ˜¾ç¤ºä¿®æ”¹åçš„é…ç½®
        echo "=== Buildozeré…ç½® ==="
        grep -E "^(title|package\.|version|requirements|android\.|orientation|main)" buildozer.spec
    
    - name: æ„å»ºAPK (Debugç‰ˆæœ¬)
      run: |
        cd robot-app
        # è®¾ç½®æ„å»ºç¼“å­˜
        mkdir -p ~/.buildozer_cache
        
        # å¼€å§‹æ„å»ºï¼ˆæ·»åŠ è¯¦ç»†æ—¥å¿—ï¼‰
        buildozer -v android debug 2>&1 | tee build.log
        
        # æ£€æŸ¥æ˜¯å¦æ„å»ºæˆåŠŸ
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "âœ… APKæ„å»ºæˆåŠŸ!"
        else
          echo "âŒ APKæ„å»ºå¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
          tail -100 build.log
          exit 1
        fi
    
    - name: ä¸Šä¼ APKæ–‡ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: robot-control-apk
        path: robot-app/bin/*.apk
        retention-days: 7
    
    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: robot-app/build.log
        retention-days: 3
    
    - name: å‘é€æ„å»ºé€šçŸ¥ (å¯é€‰)
      if: success()
      run: |
        echo "ğŸ‰ Android APKæ„å»ºæˆåŠŸ!"
        echo "åœ¨Artifactsä¸­ä¸‹è½½APKæ–‡ä»¶"

  build-status:
    runs-on: ubuntu-latest
    needs: build-android
    if: always()
    
    steps:
    - name: æ„å»ºçŠ¶æ€æ€»ç»“
      run: |
        if [ "${{ needs.build-android.result }}" == "success" ]; then
          echo "âœ… æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“± APKæ–‡ä»¶å·²ç”Ÿæˆï¼Œå¯åœ¨Artifactsä¸­ä¸‹è½½"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—"
        fi
